<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mike Subelsky">
<meta name="dcterms.date" content="2024-01-18">
<meta name="keywords" content="graph deep learning, gis, gldNET, crime forecasting, machine learning">

<title>CrimeGraph: Feature Engineering Crime Events</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="event_timestep_feature_engineering_files/libs/clipboard/clipboard.min.js"></script>
<script src="event_timestep_feature_engineering_files/libs/quarto-html/quarto.js"></script>
<script src="event_timestep_feature_engineering_files/libs/quarto-html/popper.min.js"></script>
<script src="event_timestep_feature_engineering_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="event_timestep_feature_engineering_files/libs/quarto-html/anchor.min.js"></script>
<link href="event_timestep_feature_engineering_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="event_timestep_feature_engineering_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="event_timestep_feature_engineering_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="event_timestep_feature_engineering_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="event_timestep_feature_engineering_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&amp;display=swap" rel="stylesheet">

<style>
    #header {
        background-color: #070707; /* Rich Black FOGRA 39 */
        font-family: 'Orbitron', 'Arial', sans-serif;
    }

    #header a {
        color: #b7fdfe;
    }

    #header ul.dropdown-menu {
        background-color: #070707;
    }

    #header a.disabled {
        color: #b7fdfe;
        opacity: 0.5;
    }
</style>
</head><body><ul class="nav justify-content-center" id="header">
  <li class="nav-item">
    <a class="nav-link" href="/crimegraph">
      Home
    </a>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Chapters</a>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="../street_graph_feature_engineering">Part 1</a></li>
      <li><a class="dropdown-item active" aria-current="page" href="#">Part 2</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item disabled" aria-disabled="true" href="#">Part 3 (WIP)</a></li>
    </ul>
  </li>
</ul>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>






<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#load-the-event-data" id="toc-load-the-event-data" class="nav-link" data-scroll-target="#load-the-event-data"><span class="header-section-number">1</span> Load the Event Data</a></li>
  <li><a href="#event-distribution-analysis" id="toc-event-distribution-analysis" class="nav-link" data-scroll-target="#event-distribution-analysis"><span class="header-section-number">2</span> Event Distribution Analysis</a></li>
  <li><a href="#build-event-geometry" id="toc-build-event-geometry" class="nav-link" data-scroll-target="#build-event-geometry"><span class="header-section-number">3</span> Build Event Geometry</a></li>
  <li><a href="#restrict-geographic-scope-of-events" id="toc-restrict-geographic-scope-of-events" class="nav-link" data-scroll-target="#restrict-geographic-scope-of-events"><span class="header-section-number">4</span> Restrict Geographic Scope of Events</a></li>
  <li><a href="#associate-crime-events-with-street-segment-nodes" id="toc-associate-crime-events-with-street-segment-nodes" class="nav-link" data-scroll-target="#associate-crime-events-with-street-segment-nodes"><span class="header-section-number">5</span> Associate Crime Events With Street Segment Nodes</a></li>
  <li><a href="#perform-sanity-checks" id="toc-perform-sanity-checks" class="nav-link" data-scroll-target="#perform-sanity-checks"><span class="header-section-number">6</span> Perform Sanity Checks</a></li>
  <li><a href="#create-timesteps" id="toc-create-timesteps" class="nav-link" data-scroll-target="#create-timesteps"><span class="header-section-number">7</span> Create Timesteps</a></li>
  <li><a href="#augment-the-data" id="toc-augment-the-data" class="nav-link" data-scroll-target="#augment-the-data"><span class="header-section-number">8</span> Augment the Data</a></li>
  <li><a href="#sanity-check-the-smoothing-algorithm" id="toc-sanity-check-the-smoothing-algorithm" class="nav-link" data-scroll-target="#sanity-check-the-smoothing-algorithm"><span class="header-section-number">9</span> Sanity Check the Smoothing Algorithm</a></li>
  <li><a href="#analyze-the-problem" id="toc-analyze-the-problem" class="nav-link" data-scroll-target="#analyze-the-problem"><span class="header-section-number">10</span> Analyze the Problem</a></li>
  <li><a href="#add-zero-event-timesteps" id="toc-add-zero-event-timesteps" class="nav-link" data-scroll-target="#add-zero-event-timesteps"><span class="header-section-number">11</span> Add Zero Event Timesteps</a></li>
  <li><a href="#saving-our-work" id="toc-saving-our-work" class="nav-link" data-scroll-target="#saving-our-work"><span class="header-section-number">12</span> Saving Our Work</a></li>
  <li><a href="#up-next" id="toc-up-next" class="nav-link" data-scroll-target="#up-next">Up Next</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CrimeGraph: Feature Engineering Crime Events</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><a href="https://www.subelsky.com">Mike Subelsky</a> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 18, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="introduction">Introduction</h2>
<p>In the <a href="https://www.subelsky.com/crimegraph/street_graph_feature_engineering/">part 1 CrimeGraph notebook</a>, we prepared city street segment data for use in training a graph deep learning model to forecast the risk of violent crime.</p>
<p>In this notebook, we will prepare temporal data describing the street segments and times when crimes occur, using geocoded event data provided by <a href="https://spotcrime.com/">SpotCrime</a>.</p>
<p>As before, we are following the GLDNet<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> architecture described in the 2020 paper <em><a href="https://discovery.ucl.ac.uk/id/eprint/10085742/">Graph Deep Learning Model for Network-based Predictive Hotspot Mapping of Sparse Spatio-Temporal Events</a></em> architecture.</p>
<p>The code is available on <a href="https://github.com/subelsky/crimegraph">GitHub</a>.</p>
</section>
<section id="load-the-event-data" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="load-the-event-data"><span class="header-section-number">1</span> Load the Event Data</h2>
<p>SpotCrime events were provided in CSV<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> format. The events were extracted from a variety of sources, including 911 reports and media reports. Each event includes several fields, but the ones of interest to us are <code>Date</code>, <code>Type</code>, <code>Latitude</code>, and <code>Longitude</code>.</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>events_path <span class="op">=</span> <span class="st">'../../data/spotcrime/'</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>dataframes <span class="op">=</span> []</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Walk through each SpotCrime CSV file and append to our list of events</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> os.scandir(events_path) <span class="im">as</span> entries:</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> <span class="bu">sorted</span>(entries, key<span class="op">=</span><span class="kw">lambda</span> entry: entry.name):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        file_path <span class="op">=</span> events_path <span class="op">+</span> <span class="bu">file</span>.name</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> file_path.endswith(<span class="st">'.csv'</span>):</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(file_path)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> pd.read_csv(file_path, na_filter<span class="op">=</span><span class="va">False</span>, keep_default_na<span class="op">=</span><span class="va">False</span>, index_col<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        dataframes.append(rows)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># combine all of the individual event dataframes into a single large dataframe</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>events <span class="op">=</span> pd.concat(dataframes, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Because the Date column includes time information, and we are only looking</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># at daily retrodictions and predictions, we can discard the time information</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>events[<span class="st">'Date'</span>] <span class="op">=</span> events[<span class="st">'Date'</span>].<span class="bu">str</span>.split(<span class="st">' '</span>, expand<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>]</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>events[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(events[<span class="st">'Date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'ISO8601'</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="sc">{</span><span class="bu">len</span>(events)<span class="sc">}</span><span class="ss"> events loaded'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>../../data/spotcrime/2015-Baltimore-MD.csv
../../data/spotcrime/2016-Baltimore-MD.csv
../../data/spotcrime/2017-Baltimore-MD.csv
../../data/spotcrime/2018-Baltimore-MD.csv
../../data/spotcrime/2019-Baltimore-MD.csv
../../data/spotcrime/2020-Baltimore-MD.csv
../../data/spotcrime/2021-Baltimore-MD.csv
../../data/spotcrime/2022-Baltimore-MD.csv
../../data/spotcrime/2023-Baltimore-MD.csv

2806668 events loaded</code></pre>
</div>
</div>
<p>Now we can remove extraneous columns - although some of these could be potentially useful as features for a future model. For example, <code>Description</code> could be analyzed using natural language processing techniques.</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>events.drop(columns<span class="op">=</span>[</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ID'</span>, <span class="st">'Address'</span>, <span class="st">'City'</span>, <span class="st">'State'</span>, <span class="st">'Country'</span>, <span class="st">'Zip'</span>, <span class="st">'Description'</span>, <span class="st">'Case#'</span>, <span class="st">'Incident#'</span>, <span class="st">'Report#'</span>, <span class="st">'Call#'</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Other#'</span>, <span class="st">'Link'</span>, <span class="st">'Source'</span>, <span class="st">'CallsForService'</span>, <span class="st">'NewsStory'</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="event-distribution-analysis" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="event-distribution-analysis"><span class="header-section-number">2</span> Event Distribution Analysis</h2>
<p>Feature engineering is about carefully selecting which data channels to present the model, and which to discard. The signal from some channels may overwhelm the signal from other, more predictive channels, and every channel adds to both the complexity of the model and the cost of training.</p>
<p>So far, we’ve already compressed the time dimension (stored in the <code>Date</code> column) into single-day timesteps. There are also channels for <code>Type</code>:</p>
<div class="cell" data-execution_count="50">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>events.value_counts(<span class="st">'Type'</span>).plot(kind<span class="op">=</span><span class="st">'bar'</span>, title<span class="op">=</span><span class="st">'Event Count by Type (2015-2022)'</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>plt.ticklabel_format(style<span class="op">=</span><span class="st">'plain'</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="event_timestep_feature_engineering_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Nine categories are probably too many for the scope of this experiment, and not all are likely to be equally predictive of violence.</p>
<p>If we were to use all nine categories, we would be presenting the model with a 9-dimensional feature vector<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> for each node on each day. This would be a very sparse representation, because most nodes will have zero events of a given type at any given timestep.</p>
<p>We can reduce the dimensionality of the feature vector by combining categories that are similar: <code>Assault</code>, <code>Robbery</code>, and <code>Shooting</code> can be combined as type <code>Violent</code>, while <code>Arson</code>, <code>Burglary</code>, <code>Theft</code>, and <code>Vandalism</code> can be combined as feature <code>Property</code>.</p>
<p><code>Arrest</code> seems worth preserving as a distinct feature, but the <code>Other</code> category is so general and dominant that it is not likely to be predictive of violence, so we can discard it. This would be a fruitful area for future experiments, perhaps by using natural language processing on the <code>Description</code> field of <code>Other</code> events to generate more specific classifications.</p>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove Other since it is generic and dominates the other categories</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>events <span class="op">=</span> events[<span class="op">~</span>events[<span class="st">'Type'</span>].isin([<span class="st">'Other'</span>])]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reduce dimensionality of Assault, Robbery, and Shooting</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>violent_crime_types <span class="op">=</span> [<span class="st">'Assault'</span>, <span class="st">'Robbery'</span>, <span class="st">'Shooting'</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>events[<span class="st">'Type'</span>] <span class="op">=</span> events[<span class="st">'Type'</span>].replace(violent_crime_types, <span class="st">'Violent'</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Reduce dimensionality of Arson, Burglary, Vandalism, and Theft</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>property_crime_types <span class="op">=</span> [<span class="st">'Arson'</span>, <span class="st">'Burglary'</span>, <span class="st">'Vandalism'</span>, <span class="st">'Theft'</span>]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>events[<span class="st">'Type'</span>] <span class="op">=</span> events[<span class="st">'Type'</span>].replace(property_crime_types, <span class="st">'Property'</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(events)<span class="sc">}</span><span class="ss"> primary events after filtering out "Other"'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1549308 primary events after filtering out "Other"</code></pre>
</div>
</div>
<div class="cell" data-execution_count="52">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>events.value_counts(<span class="st">'Type'</span>).plot(kind<span class="op">=</span><span class="st">'bar'</span>, title<span class="op">=</span><span class="st">'Count by Event Type (2015-2021)'</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="event_timestep_feature_engineering_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="build-event-geometry" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="build-event-geometry"><span class="header-section-number">3</span> Build Event Geometry</h2>
<p>The SpotCrime data includes <code>Latitude</code> and <code>Longitude</code> values as strings of of numbers. In order to assign crime events to a street segment, we need to convert those coordinates into a point geometry that can be used with our street graph. The <a href="https://geopandas.org/">geopandas</a> library provides a way to store the event data as geometric objects, in a <code>GeoDataFrame</code>.</p>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert our events dataframe into to a geopandas dataframe by composing a</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 'geometry' column from the 'Latitude' and 'Longitude' columns</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>events[<span class="st">'geometry'</span>] <span class="op">=</span> events.<span class="bu">apply</span>(<span class="kw">lambda</span> row: Point(row.Longitude, row.Latitude), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>events.drop(columns<span class="op">=</span>[<span class="st">'Latitude'</span>, <span class="st">'Longitude'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>events_gdf <span class="op">=</span> gpd.GeoDataFrame(events)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>events_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Type</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (-76.60609 39.29915)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (-76.61247 39.30823)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (-76.56809 39.35307)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (-76.63680 39.28982)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (-76.58299 39.36264)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The event locations are specified in spherical coordinates (hours/minutes/seconds), using a coordinate reference system called <a href="https://en.wikipedia.org/wiki/World_Geodetic_System">WGS84</a>, while the street graph we created in <a href="https://www.subelsky.com/crimegraph/street_graph_feature_engineering/">part 1</a> uses a planar coordinate reference system called <a href="https://epsg.io/26985">NAD83</a>. <code>NAD83</code> enables us to treat the city as a flat surface, so that we can compute linear distances in meters.</p>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original SpotCrime coordinates given  WGS84, aka EPSG:4326 spherical coordinates</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>events_gdf.crs <span class="op">=</span> <span class="st">'EPSG:4326'</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert 'geometry' column to planar coordinates NAD 83 (aka EPSG:26985)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>events_gdf <span class="op">=</span> events_gdf.to_crs(<span class="st">'EPSG:26985'</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>events_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Type</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (433977.600 181288.835)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (433423.454 182294.867)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (437227.394 187290.304)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (431332.752 180242.042)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (435937.871 188346.235)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="restrict-geographic-scope-of-events" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="restrict-geographic-scope-of-events"><span class="header-section-number">4</span> Restrict Geographic Scope of Events</h2>
<p>In part 1, we limited the scope of interest to a bounding box across the width of the center of the city, in order to reduce the computational demands of the experiment. In this step, we remove events that fall outside of that bounding box.</p>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lib.geo_utils <span class="im">import</span> filter_gdf</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this is the same box used to constrain the street graph in step 1</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>minLat, minLon <span class="op">=</span> <span class="fl">39.281302796434016</span>, <span class="op">-</span><span class="fl">76.665</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>maxLat, maxLon<span class="op">=</span><span class="fl">39.299</span>, <span class="op">-</span><span class="fl">76.575</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>filtered_events_gdf <span class="op">=</span> filter_gdf(events_gdf, minLat<span class="op">=</span>minLat, minLon<span class="op">=</span>minLon, maxLat<span class="op">=</span>maxLat, maxLon<span class="op">=</span>maxLon)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(filtered_events_gdf)<span class="sc">}</span><span class="ss"> events in central Baltimore'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>341342 events in central Baltimore</code></pre>
</div>
</div>
<div class="cell" data-execution_count="56">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lib.plots <span class="im">import</span> plot_events_on_map</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>plot_events_on_map(filtered_events_gdf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="event_timestep_feature_engineering_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="associate-crime-events-with-street-segment-nodes" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="associate-crime-events-with-street-segment-nodes"><span class="header-section-number">5</span> Associate Crime Events With Street Segment Nodes</h2>
<p>Now that we have a prepared a set of events with planar coordinates, we can use the street graph built in part 1 to associate events with nearby street segments.</p>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../../data/processed/baltimore_street_graph.gpickle'</span>, <span class="st">'rb'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> pickle.load(<span class="bu">file</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The street segment nodes in the graph look like this:</p>
<div class="cell" data-execution_count="58">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(G)<span class="sc">}</span><span class="ss"> nodes in the street graph'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> node <span class="kw">in</span> <span class="bu">list</span>(G.nodes.data())[<span class="va">None</span>:<span class="dv">5</span>:<span class="va">None</span>]:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(node)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>766 nodes in the street graph

(0, {'NodeID': 367225, 'name': 'N DUKELAND ST', 'position': (429023.8628222718, 181450.00684655222)})
(1, {'NodeID': 367313, 'name': 'GREENMOUNT AVE', 'position': (433808.63742829155, 181873.77924021168)})
(2, {'NodeID': 367428, 'name': 'S CURLEY ST', 'position': (436601.280827219, 180889.90036487588)})
(3, {'NodeID': 368071, 'name': 'CHRISTIAN ST', 'position': (430246.3910939129, 179351.73809093094)})
(4, {'NodeID': 368342, 'name': 'E WINE CT', 'position': (433246.963858756, 180159.531350441)})</code></pre>
</div>
</div>
<p>While the edges that represent intersections between streets looks like this:</p>
<div class="cell" data-execution_count="60">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sanity check that the edges were loaded properly</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>edges <span class="op">=</span> [(u, v) <span class="cf">for</span> u, v, data <span class="kw">in</span> G.edges(data<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(edges)<span class="sc">}</span><span class="ss"> edges in the street graph'</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(G.edges.data())[<span class="va">None</span>:<span class="dv">5</span>:<span class="va">None</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>2395 edges in the street graph</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>[(0, 360, {'distance': 76.50819939674132, 'weight': 0.9948103975797566}),
 (1, 172, {'distance': 74.01206460762958, 'weight': 0.9951426922082988}),
 (1, 249, {'distance': 1679.2215902070416, 'weight': 0.08155515917109929}),
 (1, 525, {'distance': 209.5358284935493, 'weight': 0.9617248376116582}),
 (2, 127, {'distance': 1091.7130241181349, 'weight': 0.3466599476923783})]</code></pre>
</div>
</div>
<p>We now create a GeoDataFrame using the positions of each node, in order to intersect the node locations with the event locations.</p>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>nodes_gdf <span class="op">=</span> gpd.GeoDataFrame(index<span class="op">=</span>[n <span class="cf">for</span> n <span class="kw">in</span> G.nodes()],</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                             geometry<span class="op">=</span>[Point(data[<span class="st">'position'</span>]) <span class="cf">for</span> n, data <span class="kw">in</span> G.nodes(data<span class="op">=</span><span class="va">True</span>)],</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                             crs<span class="op">=</span>events_gdf.crs)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>nodes_gdf.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>POINT (429023.863 181450.007)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>POINT (433808.637 181873.779)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>POINT (436601.281 180889.900)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>POINT (430246.391 179351.738)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>POINT (433246.964 180159.531)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The <code>associate_events_with_nodes()</code> function used below is responsible for matching a geolocated event to the nearest geolocated street segment node. The source code can be <a href="https://github.com/subelsky/crimegraph">found on GitHub</a>.</p>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use library code to create a new events dataframe, containing the original events</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># but with an additional NodeIndex column pointing to the identity of the street</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># segment node closest to the event location</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lib.events <span class="im">import</span> associate_events_with_nodes</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>events_with_nodes_gdf <span class="op">=</span> associate_events_with_nodes(filtered_events_gdf.copy(), nodes_gdf)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>events_with_nodes_gdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Type</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">NodeIndex</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>2015-01-01</td>
<td>Violent</td>
<td>POINT (431332.752 180242.042)</td>
<td>341</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>2015-01-01</td>
<td>Property</td>
<td>POINT (435855.896 180862.773)</td>
<td>581</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2015-01-01</td>
<td>Property</td>
<td>POINT (434467.335 180626.844)</td>
<td>712</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2015-01-01</td>
<td>Property</td>
<td>POINT (433200.177 180219.014)</td>
<td>200</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17</td>
<td>2015-01-01</td>
<td>Property</td>
<td>POINT (433365.953 180121.740)</td>
<td>485</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2806082</td>
<td>2023-11-06</td>
<td>Violent</td>
<td>POINT (429868.726 181220.342)</td>
<td>346</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2806092</td>
<td>2023-11-06</td>
<td>Violent</td>
<td>POINT (436293.361 180922.361)</td>
<td>584</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2806094</td>
<td>2023-11-06</td>
<td>Violent</td>
<td>POINT (430494.129 179387.371)</td>
<td>165</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2806102</td>
<td>2023-11-06</td>
<td>Violent</td>
<td>POINT (434898.160 179884.578)</td>
<td>408</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2806107</td>
<td>2023-11-06</td>
<td>Violent</td>
<td>POINT (429885.091 181226.621)</td>
<td>346</td>
</tr>
</tbody>
</table>

<p>341342 rows × 4 columns</p>
</div>
</div>
</div>
</section>
<section id="perform-sanity-checks" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="perform-sanity-checks"><span class="header-section-number">6</span> Perform Sanity Checks</h2>
<div class="cell" data-execution_count="62">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform some sanity checks</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>unique_node_count <span class="op">=</span> events_with_nodes_gdf.value_counts(<span class="st">'NodeIndex'</span>).count()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>nodes_with_zero_events <span class="op">=</span> nodes_gdf[<span class="op">~</span>nodes_gdf.index.isin(events_with_nodes_gdf[<span class="st">'NodeIndex'</span>])]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>unique_node_count<span class="sc">}</span><span class="ss"> unique nodes associated with at least one crime event'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(nodes_with_zero_events)<span class="sc">}</span><span class="ss"> nodes with zero events'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>700 unique nodes associated with at least one crime event
66 nodes with zero events</code></pre>
</div>
</div>
<div class="cell" data-execution_count="63">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate crimes by their nearest node ID to get the sum total for each node</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>crime_count_per_node <span class="op">=</span> events_with_nodes_gdf.groupby(<span class="st">'NodeIndex'</span>).size()</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge this count with the nodes GeoDataFrame</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>merged_nodes_gdf <span class="op">=</span> nodes_gdf.merge(crime_count_per_node.rename(<span class="st">'crime_count'</span>), left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># drop nodes that have no crimes, since this is only for display purposes</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>merged_nodes_gdf.dropna(subset<span class="op">=</span>[<span class="st">'crime_count'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This plot shows the results of our work so far. All crime events have been fixed to a specific street segment node, and the plot looks reasonable.</p>
<div class="cell" data-execution_count="79">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tkinter <span class="im">import</span> font</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>city_gdf <span class="op">=</span> gpd.read_file(<span class="st">'../../data/city_streets/MDOT_Know_Your_Roads.shp'</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>city_gdf <span class="op">=</span> city_gdf.to_crs(epsg<span class="op">=</span><span class="dv">26985</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">30</span>))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>city_gdf.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'lightblue'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> merged_nodes_gdf.iterrows():</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    ax.text(row.geometry.x, row.geometry.y, <span class="bu">str</span>(<span class="bu">int</span>(row.crime_count)), fontsize<span class="op">=</span><span class="dv">8</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>minLong, minLat, maxLong, maxLat <span class="op">=</span> merged_nodes_gdf.total_bounds</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(minLong, maxLong)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(minLat, maxLat)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)  </span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Total Crime Counts per Street Segment Node'</span>, fontsize<span class="op">=</span><span class="dv">18</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="event_timestep_feature_engineering_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="create-timesteps" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="create-timesteps"><span class="header-section-number">7</span> Create Timesteps</h2>
<p>We now need to reorganize the events dataframe into a series of daily snapshots that aggregate crime counts into a feature vector for each node, suitable for training the model and for using the model to make predictions.</p>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group events by Date and NodeIndex to get the number of events of each type</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>timesteps <span class="op">=</span> events_with_nodes_gdf.pivot_table(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="st">'Date'</span>, <span class="st">'NodeIndex'</span>],</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span><span class="st">'Type'</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    aggfunc<span class="op">=</span><span class="st">'size'</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>timesteps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Type</th>
<th data-quarto-table-cell-role="th">Arrest</th>
<th data-quarto-table-cell-role="th">Property</th>
<th data-quarto-table-cell-role="th">Violent</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">NodeIndex</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2015-01-01</td>
<td data-quarto-table-cell-role="th">18</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">82</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">2023-11-06</td>
<td data-quarto-table-cell-role="th">700</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">705</td>
<td>1</td>
<td>2</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">723</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">729</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">750</td>
<td>0</td>
<td>2</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>234756 rows × 3 columns</p>
</div>
</div>
</div>
</section>
<section id="augment-the-data" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="augment-the-data"><span class="header-section-number">8</span> Augment the Data</h2>
<p>If we present the events data as-is, we’ll run into a problem. For most nodes on any given timestep, there will be zero crime, resulting in a very sparse feature vector that is too meager for learning.</p>
<p>As demonstrated in the GLDnet paper, we can solve this problem by exponentially smoothing the data, a data augmentation technique that will help the model generalize better and learn more quickly.</p>
<p>This figure comes from the paper, illustrating how the sparse, discrete crime count values (the vertical lines) are smoothed across timesteps to create continuous, smoothed values:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="event_timestep_feature_engineering_files/figure-html/ca61a565-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure 2 from <em>Graph Deep Learning Model for Network-based Predictive Hotspot Mapping of Sparse Spatio-Temporal Events</em>, showing the smooth decay of discrete single-day crime event counts into a continuous distribution across the preceding days</figcaption>
</figure>
</div>
<p>Source code for the <code>perform_exponential_smoothing()</code> function called below can be <a href="https://github.com/subelsky/crimegraph">found on GitHub</a>.</p>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lib.events <span class="im">import</span> perform_exponential_smoothing</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>smoothing_factor <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>smoothed_timesteps <span class="op">=</span> perform_exponential_smoothing(timesteps, smoothing_factor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sanity-check-the-smoothing-algorithm" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="sanity-check-the-smoothing-algorithm"><span class="header-section-number">9</span> Sanity Check the Smoothing Algorithm</h2>
<p>When we try to re-create the plot from the paper, we see a problem. Our smoothed values decay very slowly:</p>
<div class="cell" data-execution_count="67">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lib.plots <span class="im">import</span> plot_event_counts</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>plot_event_counts(smoothed_timesteps, <span class="dv">729</span>, <span class="st">'Property'</span>, num_days<span class="op">=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="event_timestep_feature_engineering_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="analyze-the-problem" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="analyze-the-problem"><span class="header-section-number">10</span> Analyze the Problem</h2>
<p>I tried many values for the <code>alpha</code> smoothing factor, but the same pattern persisted. I eventually realized that the timesteps dataframe is itself sparse: because there are no zero values for dates when there are no crimes, the smoothing function directly interpolates between events separated by many timesteps.</p>
<p>The fix was to add zero values to the events dataframe for any missing dates<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> so that the smoothing function could decay to zero between events separated by many timesteps.</p>
</section>
<section id="add-zero-event-timesteps" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="add-zero-event-timesteps"><span class="header-section-number">11</span> Add Zero Event Timesteps</h2>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lib.events <span class="im">import</span> interpolate_and_smooth</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>interpolated_smoothed_timesteps <span class="op">=</span> interpolate_and_smooth(timesteps, <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="69">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lib.plots <span class="im">import</span> plot_event_counts</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>plot_event_counts(interpolated_smoothed_timesteps, <span class="dv">729</span>, <span class="st">'Property'</span>, num_days<span class="op">=</span><span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="event_timestep_feature_engineering_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>That looks better. Note that the smoothing factor <code>0.5</code> was chosen arbitrarily through trial and error. The true value will need to be chosen via training experiments<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<p>Here is a sample of the final dataframe to be used for training the model. Note that we are keeping the original columns so that the smoothing function can be run again during those experiments:</p>
<div class="cell" data-execution_count="70">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>interpolated_smoothed_timesteps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="70">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Type</th>
<th data-quarto-table-cell-role="th">Arrest</th>
<th data-quarto-table-cell-role="th">Property</th>
<th data-quarto-table-cell-role="th">Violent</th>
<th data-quarto-table-cell-role="th">ArrestSmoothed</th>
<th data-quarto-table-cell-role="th">PropertySmoothed</th>
<th data-quarto-table-cell-role="th">ViolentSmoothed</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">NodeIndex</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015-01-01</td>
<td data-quarto-table-cell-role="th">18</td>
<td>0.0</td>
<td>1.0</td>
<td>1.0</td>
<td>0.0</td>
<td>1.000000e+00</td>
<td>1.000000e+00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2015-01-02</td>
<td data-quarto-table-cell-role="th">18</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>5.000000e-01</td>
<td>5.000000e-01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015-01-03</td>
<td data-quarto-table-cell-role="th">18</td>
<td>0.0</td>
<td>1.0</td>
<td>1.0</td>
<td>0.0</td>
<td>7.500000e-01</td>
<td>7.500000e-01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2015-01-04</td>
<td data-quarto-table-cell-role="th">18</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>3.750000e-01</td>
<td>3.750000e-01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015-01-05</td>
<td data-quarto-table-cell-role="th">18</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.875000e-01</td>
<td>1.875000e-01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2023-11-02</td>
<td data-quarto-table-cell-role="th">653</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>3.970467e-23</td>
<td>3.587324e-43</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2023-11-03</td>
<td data-quarto-table-cell-role="th">653</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.985233e-23</td>
<td>1.793662e-43</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2023-11-04</td>
<td data-quarto-table-cell-role="th">653</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>9.926167e-24</td>
<td>8.968310e-44</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2023-11-05</td>
<td data-quarto-table-cell-role="th">653</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>4.963084e-24</td>
<td>4.484155e-44</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2023-11-06</td>
<td data-quarto-table-cell-role="th">653</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>2.481542e-24</td>
<td>2.242078e-44</td>
</tr>
</tbody>
</table>

<p>2262400 rows × 6 columns</p>
</div>
</div>
</div>
</section>
<section id="saving-our-work" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="saving-our-work"><span class="header-section-number">12</span> Saving Our Work</h2>
<p>As in part 1, we save the timesteps to disk for use when training the model. We also save the events data, in case we want to use it for future experiments.</p>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>smoothed_timesteps.to_csv(<span class="st">'../../data/processed/timesteps.csv.gz'</span>, compression<span class="op">=</span><span class="st">'gzip'</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>events_with_nodes_gdf.to_file(<span class="st">'../../data/processed/events_with_nodes_gdf.geojson'</span>, driver<span class="op">=</span><span class="st">'GeoJSON'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="up-next" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="up-next">Up Next</h2>
<p>We’re finally ready to start building a basic <code>GLDnet</code> model - stay tuned for part 3!</p>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Gated Localized Diffusion<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Comma-Separated Values, a common way to represent tabular information in a text-based format<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Meaning there would be a list of nine numbers, for each node, for each day<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>I tried using more sophisticated methods that would save memory without needing to materialize so many empty rows, but couldn’t get things working correctly. In the interest of time, I decided to use this brute-force approach<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>A process called Hyperparameter Optimization<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>